<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>index.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-middy-redis.html">middy-redis</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-middy-redis.html#~after">after</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-middy-redis.html#~before">before</a></span></li><li class="nav-heading"><a href="global.html">Globals</a></li>
</nav>

<div id="main">
    
    <h1 class="page-title">index.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>const debug = require('debug')('middy-redis')
const redisClient = require('redis')

/**
 * This callback is used to resolve the `redisURI` when passed an event. It should a valid redisURI as a string (can be async)
 *
 * @callback redisURIResolver
 * @async
 * @param {Object} event - This is the raw event object (can be altered by previous middlewares)
 * @returns {string} The `redisURI`
 */

/**
 * Middy redis - Loads up redis for you before calling your handler
 * @module middy-redis
 * @param {Object} config - Configuration on how to find your redis instance (redisURIResolver has priority if both defined)
 * @param {string} config.redisURI - Redis url ex: `redis://localhost:6379`
 * @param {redisURIResolver} config.redisURIResolver - Function called to get the `redisURI` at runtime
 * @example
 *
 * const middyRedis = require('middy-redis')
 * const middy = require('middy')
 *
 * const someHandler = (event, context, callback) => {
 *
 *   // The redis instance is accessible from the event object
 *   event.redis.get('some_key', (err, value) => {
 *     if (err) {
 *       return callback(err)
 *     }
 *     callback(null, value)
 *   }
 * }
 *
 * // Lets you connect to a different redis instance based on information in the event.
 * // This example hard codes a value.
 * let resolver = (event) => {
 *   return 'redis://localhost:6379'
 * }
 *
 * const handler = middy(someHandler)
 *   .use(middyRedis({ redisURIResolver: resolver })
 *
 * module.exports = { handler }
 *
 */
module.exports = ({ redisURI = undefined, redisURIResolver = undefined } = {}) => {
  if (!redisURI &amp;&amp; !redisURIResolver) {
    throw new Error('middy-redis configuration error: Please provide a redisURI or redisURIResolver')
  }

  /**
   * Before - Called to load redis, will wait until redis is ready to proceed
   * @function before
   * @param {Object} handler - Current handler
   * @modifies {handler}
   */
  const before = async (handler) => {
    let resolvedRedisURI = redisURIResolver ? (await redisURIResolver(handler.event)) : redisURI
    debug('resolved redis URI', resolvedRedisURI)
    const redis = redisClient.createClient(resolvedRedisURI)
    await new Promise((resolve, reject) => {
      debug('waiting for redis to be ready')
      redis.on('ready', () => {
        debug('redis ready')
        resolve()
      })
    })
    handler.event.redis = redis
  }

  /**
   * After - Called to quit redis and close the connection
   * @function after
   * @param {Object} handler - Current handler
   * @modifies {handler}
   */
  const after = async (handler) => {
    return new Promise((resolve, reject) => {
      debug('attempting to quit redis')
      handler.event.redis.quit(() => {
        debug('redis quit successful')
        handler.event.redis = undefined
        resolve()
      })
    })
  }

  return {
    before,
    after
  }
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Sun Apr 08 2018 18:11:57 GMT-0700 (PDT) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
